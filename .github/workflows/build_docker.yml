name: Build Private Docker Image

on:
  schedule:
    - cron: '0 2 */2 * *'
  workflow_dispatch:
    inputs:
      version:
        description: 'Manual version override (alphanumeric and dashes only)'
        required: false
        default: ''
        type: string

permissions:
  contents: read
  packages: write

jobs:
  check-and-build:
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    outputs:
      should_build: ${{ steps.check.outputs.should_build }}
      version: ${{ steps.version.outputs.version }}
      owner: ${{ steps.repo.outputs.owner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set lowercase repository owner
        id: repo
        run: |
          echo "owner=${GITHUB_REPOSITORY_OWNER,,}" >> $GITHUB_OUTPUT
          
      - name: Validate version input
        if: github.event.inputs.version != ''
        env:
          VERSION: ${{ github.event.inputs.version }}
        run: |
          if [[ ${#VERSION} -gt 64 ]]; then
            echo "Error: Version too long (max 64 characters)"
            exit 1
          fi
          
          if [[ ! "$VERSION" =~ ^[a-zA-Z0-9.-]+$ ]]; then
            echo "Error: Invalid version format. Only alphanumeric, dots, and dashes allowed."
            exit 1
          fi
          
          if [[ "$VERSION" == *".."* ]]; then
            echo "Error: Version cannot contain .."
            exit 1
          fi
          
          if [[ "$VERSION" =~ \.{2,} ]]; then
            echo "Error: Version cannot contain consecutive dots"
            exit 1
          fi
          
          echo "Version validation passed: $VERSION"
          
      - name: Check if build needed
        id: check
        run: |
          LAST_BUILD_TAG=$(git tag -l "build-*" | sort -V | tail -n1 || echo "")
          
          if [ -z "$LAST_BUILD_TAG" ]; then
            echo "should_build=true" >> $GITHUB_OUTPUT
            echo "No previous builds found"
          else
            LAST_BUILD_SHA=$(echo "$LAST_BUILD_TAG" | sed 's/build-//')
            CURRENT_SHA=$(git rev-parse --short HEAD)
            
            if [ "$LAST_BUILD_SHA" = "$CURRENT_SHA" ]; then
              echo "should_build=false" >> $GITHUB_OUTPUT
              echo "No changes since last build"
            else
              echo "should_build=true" >> $GITHUB_OUTPUT
              echo "Changes detected"
            fi
          fi
          
      - name: Generate version
        if: steps.check.outputs.should_build == 'true'
        id: version
        env:
          INPUT_VERSION: ${{ github.event.inputs.version }}
        run: |
          if [ -n "$INPUT_VERSION" ]; then
            VERSION=$(echo "$INPUT_VERSION" | tr -cd '[:alnum:].-')
          else
            DATE=$(date +%Y%m%d)
            SHA=$(git rev-parse --short HEAD)
            VERSION="$DATE-$SHA"
          fi
          
          if [ -z "$VERSION" ]; then
            echo "Error: Version is empty after sanitization"
            exit 1
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Building version: dev-$VERSION"

  build-platform:
    needs: check-and-build
    if: needs.check-and-build.outputs.should_build == 'true'
    permissions:
      contents: read
      packages: write
    strategy:
      fail-fast: false
      matrix:
        include:
          - platform: linux/amd64
            runner: ubuntu-latest
          - platform: linux/arm64
            runner: macos-latest  # M1/M2 chip for native ARM64
    runs-on: ${{ matrix.runner }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        
      - name: Set up Docker (macOS)
        if: runner.os == 'macOS'
        run: |
          # Install Docker on macOS
          brew install docker docker-buildx
          # Start colima (lightweight Docker runtime for macOS)
          brew install colima
          colima start --cpu 3 --memory 6 --disk 60
          
          # Verify Docker is working
          docker version
          docker info
        
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ needs.check-and-build.outputs.owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ghcr.io/${{ needs.check-and-build.outputs.owner }}/librechat-api
          
      - name: Build and push by digest
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile.multi
          platforms: ${{ matrix.platform }}
          target: api-build
          build-args: |
            NODE_MAX_OLD_SPACE_SIZE=6144
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha,scope=build-${{ matrix.platform }}
          cache-to: type=gha,mode=max,scope=build-${{ matrix.platform }}
          outputs: type=image,name=ghcr.io/${{ needs.check-and-build.outputs.owner }}/librechat-api,push-by-digest=true,name-canonical=true,push=true
          
      - name: Export digest
        run: |
          mkdir -p /tmp/digests
          digest="${{ steps.build.outputs.digest }}"
          touch "/tmp/digests/${digest#sha256:}"
          
      - name: Upload digest
        uses: actions/upload-artifact@v4
        with:
          name: digests-${{ strategy.job-index }}
          path: /tmp/digests/*
          if-no-files-found: error
          retention-days: 1

  merge-and-push:
    needs: [check-and-build, build-platform]
    runs-on: ubuntu-latest
    permissions:
      contents: write
      packages: write
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          
      - name: Download digests
        uses: actions/download-artifact@v4
        with:
          path: /tmp/digests
          pattern: digests-*
          merge-multiple: true
          
      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v3
        
      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ needs.check-and-build.outputs.owner }}
          password: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Create manifest list and push
        working-directory: /tmp/digests
        run: |
          docker buildx imagetools create \
            --tag ghcr.io/${{ needs.check-and-build.outputs.owner }}/librechat-api:dev-${{ needs.check-and-build.outputs.version }} \
            --tag ghcr.io/${{ needs.check-and-build.outputs.owner }}/librechat-api:latest \
            $(printf 'ghcr.io/${{ needs.check-and-build.outputs.owner }}/librechat-api@sha256:%s ' *)
            
      - name: Inspect image
        run: |
          docker buildx imagetools inspect ghcr.io/${{ needs.check-and-build.outputs.owner }}/librechat-api:dev-${{ needs.check-and-build.outputs.version }}
          
      - name: Tag this build
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          SHA=$(git rev-parse --short HEAD)
          git tag "build-$SHA"
          git push origin "build-$SHA"
          
      - name: Checkout deployment repo
        uses: actions/checkout@v4
        with:
          repository: kspaeth/kommpass-dev
          token: ${{ secrets.KOMMPASS_PAT }}
          path: kommpass-dev
          
      - name: Update docker-compose.override.yml
        env:
          VERSION: ${{ needs.check-and-build.outputs.version }}
          OWNER: ${{ needs.check-and-build.outputs.owner }}
        working-directory: kommpass-dev
        run: |
          FILE="docker-compose.override.yml"
          
          if [ ! -f "$FILE" ]; then
            echo "Error: $FILE not found"
            exit 1
          fi
          
          cp "$FILE" "$FILE.backup"
          
          SAFE_VERSION=$(echo "$VERSION" | tr -cd '[:alnum.].-')
          
          if [ -z "$SAFE_VERSION" ]; then
            echo "Error: Version is empty after sanitization"
            exit 1
          fi
          
          # Update with lowercase repository owner
          sed -i "s|image: ghcr.io/.*/librechat-api:dev-[a-zA-Z0-9.-]*|image: ghcr.io/$OWNER/librechat-api:dev-$SAFE_VERSION|g" "$FILE"
          
          if ! grep -q "ghcr.io/$OWNER/librechat-api:dev-$SAFE_VERSION" "$FILE"; then
            echo "Error: Failed to update image version in $FILE"
            echo "File contents:"
            cat "$FILE"
            exit 1
          fi
          
          echo "Updated to version: dev-$SAFE_VERSION"
          echo "Updated lines:"
          grep "ghcr.io/.*/librechat-api" "$FILE"
          
      - name: Commit and push deployment config
        env:
          VERSION: ${{ needs.check-and-build.outputs.version }}
        working-directory: kommpass-dev
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
          git add docker-compose.override.yml
          
          if git diff --staged --quiet; then
            echo "No changes to commit"
          else
            SAFE_VERSION=$(echo "$VERSION" | tr -cd '[:alnum.].-')
            git commit -m "Update librechat-api to version dev-$SAFE_VERSION"
            git push
            echo "Successfully pushed deployment config update"
          fi
